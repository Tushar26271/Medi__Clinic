@model Medi_Clinic.Models.PhysicianAdvice
@{
    ViewData["Title"] = "Add Advice";
    Layout = "~/Views/Shared/_PhysicianLayout.cshtml";
}

<div class="card shadow-sm border-0 rounded-4">
    <div class="card-body p-4">

        <!-- Header -->
        <div class="mb-4">
            <h4 class="fw-bold mb-1">Add Medical Advice</h4>
            <small class="text-muted">
                Provide diagnosis and prescribe medicines for the patient
            </small>
        </div>

        <form asp-action="AddAdvice" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="ScheduleId" />

            <!-- Validation -->
            <div asp-validation-summary="ModelOnly"
                 class="alert alert-danger rounded-3"></div>

            <!-- Advice Section -->
            <div class="mb-4">
                <label class="form-label fw-semibold">Medical Advice</label>
<textarea asp-for="Advice"
          class="form-control rounded-3"
          rows="3"
          placeholder="Enter medical advice"></textarea>
                <span asp-validation-for="Advice" class="text-danger"></span>
            </div>

            <div class="mb-4">
                <label class="form-label fw-semibold">Additional Notes</label>
<textarea asp-for="Note"
          class="form-control rounded-3"
          rows="2"
          placeholder="Optional notes"></textarea>
            </div>

            <hr class="my-4" />

            <!-- Prescription Section -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-semibold mb-0">PhysicianPrescrips</h5>

                <button type="button"
                        class="btn btn-outline-primary rounded-pill px-3"
                        id="addRow">
                    <i class="bi bi-plus-circle"></i> Add Medicine
                </button>
            </div>

            <div class="table-responsive">
                <table class="table align-middle" id="prescriptionTable">
                    <thead class="table-light">
                        <tr>
                            <th>Drug</th>
                            <th>Prescription</th>
                            <th>Dosage</th>
                            <th width="60"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.PhysicianPrescrips.Count; i++)
                        {
                            <tr>
                                <td>
                                    <select asp-for="PhysicianPrescrips.ToList()[i].DrugId"
                                            asp-items="ViewBag.Drugs"
                                            class="form-select rounded-3">
                                        <option value="">-- Select Drug --</option>
                                    </select>
                                </td>
                                <td>
                                    <input asp-for="PhysicianPrescrips.ToList()[i].Prescription"
                                           class="form-control rounded-3"
                                           placeholder="e.g. After food" />
                                </td>
                                <td>
                                    <input asp-for="PhysicianPrescrips.ToList()[i].Dosage"
                                           class="form-control rounded-3"
                                           placeholder="e.g. 1-0-1" />
                                </td>
                                <td>
                                    <button type="button"
                                            class="btn btn-danger btn-sm remove-row">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="mt-4 text-end">
                <button type="submit"
                        class="btn btn-success rounded-pill px-4">
                    <i class="bi bi-check-circle"></i> Save Advice
                </button>
            </div>

        </form>
    </div>
</div>

@section Scripts {

    <script>
                const drugOptions = `
        <option value="">-- Select Drug --</option>
                    @foreach (var d in (SelectList)ViewBag.Drugs)
                    {
            <option value="@d.Value">@d.Text</option>
                    }
                `;

                let index = @Model.PhysicianPrescrips.Count;

                document.getElementById("addRow").addEventListener("click", function () {
                    const table = document.querySelector("#prescriptionTable tbody");

                    const row = `
        <tr>
        <td>
        <select name="PhysicianPrescrips[${index}].DrugId"
                                    class="form-select rounded-3">
                                ${drugOptions}
        </select>
        </td>
        <td>
        <input name="PhysicianPrescrips[${index}].Prescription"
                                   class="form-control rounded-3"
                                   placeholder="e.g. After food" />
        </td>
        <td>
        <input name="PhysicianPrescrips[${index}].Dosage"
                                   class="form-control rounded-3"
                                   placeholder="e.g. 1-0-1" />
        </td>
        <td>
        <button type="button"
                                    class="btn btn-danger btn-sm remove-row">
        <i class="bi bi-x-lg"></i>
        </button>
        </td>
        </tr>`;

                    table.insertAdjacentHTML("beforeend", row);
                    index++;
                });

                document.addEventListener("click", function (e) {
                    if (e.target.closest(".remove-row")) {
                        e.target.closest("tr").remove();
                    }
                });
    </script>

}